name: FOSS Check

on:
  push:
    branches:
      - IAV-FF-feature-foss-check-integration-192

jobs:
  foss-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      # Step 4: Generate SBOM for the project
      - name: Generate SBOM
        run: |
          cd packages/frontend-framework && npm sbom --sbom-format spdx --output SBOM.spdx
        env:
          NODE_OPTIONS: '--max_old_space_size=4096'

      # Step 5: Run npm audit for security vulnerability checks
      - name: Run npm audit
        run: npm install && npm audit --audit-level=high

      # Step 6: Check for license compliance using Licensee
      - name: License Compliance Check
        run: |
          # Install Licensee gem locally
          gem install licensee --user-install

          # Add the gem executables directory to the PATH
          export PATH="$HOME/.local/share/gem/ruby/3.2.0/bin:$PATH"

          # Run Licensee tool
          licensee detect . --json > license-compliance-report.json

          # Output the report for debugging purposes
          cat license-compliance-report.json


          # Check exit code (licensee returns non-zero if issues are found)
        continue-on-error: false # Fail the workflow if licenses are non-compliant

      # Notify on failure
      - name: Email Notification (failure alerts)
        if: failure()
        run: |
          echo "FOSS checks failed for the latest push. Email alerts will be integrated later here."
